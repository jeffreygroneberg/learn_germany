<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Lerne die HauptstÃ¤dte der BundeslÃ¤nder!</title>
  <style>
    :root {
      --bg: #f0f4f8;
      --card: #ffffff;
      --primary: #2563eb;
      --correct: #16a34a;
      --wrong: #dc2626;
      --highlight: #fbbf24;
      --text: #1e293b;
      --muted: #64748b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      background: var(--primary);
      color: #fff;
      text-align: center;
      padding: 1rem;
    }
    header h1 { font-size: 1.6rem; }
    header p  { font-size: 0.95rem; opacity: .85; margin-top: .25rem; }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      justify-content: center;
    }

    /* ---------- Map ---------- */
    #mapWrap {
      flex: 1 1 500px;
      max-width: 600px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,.08);
      padding: 1rem;
      position: relative;
      overflow: hidden;
      touch-action: none;
    }
    #mapWrap svg {
      width: 100%;
      height: auto;
      transform-origin: 0 0;
      transition: transform .08s linear;
      display: block;
    }
    #btnResetZoom {
      position: absolute;
      top: .5rem;
      right: .5rem;
      z-index: 10;
      background: var(--card);
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: .35rem .6rem;
      font-size: .8rem;
      cursor: pointer;
      display: none;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }
    #btnResetZoom:active { transform: scale(.95); }
    #btnFlagToggle {
      position: absolute;
      top: .5rem;
      left: .5rem;
      z-index: 10;
      background: var(--card);
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: .35rem .6rem;
      font-size: .8rem;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,.12);
    }
    #btnFlagToggle:active { transform: scale(.95); }
    #btnFlagToggle.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .state {
      fill: #cbd5e1;
      stroke: #ffffff;
      stroke-width: 1.2;
      cursor: pointer;
      transition: fill .18s ease, opacity .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .state:hover { opacity: .8; }
    @media (pointer: coarse) {
      .state { stroke-width: 1.8; }
    }
    .state.active-question { fill: var(--highlight); }
    .state.correct  { fill: var(--correct); }
    .state.wrong    { fill: var(--wrong); }
    .state.learned  { fill: #86efac; }  /* previously answered correctly */

    /* Arrow annotation for wrong answers */
    #arrowOverlay { pointer-events: none; }
    #arrowOverlay line {
      stroke: var(--wrong);
      stroke-width: 3;
      stroke-dasharray: 10 5;
    }
    #arrowOverlay line.animated {
      animation: drawLine 0.8s ease-out forwards;
    }
    @keyframes drawLine {
      from { stroke-dashoffset: var(--line-len); opacity: 0.3; }
      to   { stroke-dashoffset: 0; opacity: 1; }
    }
    #arrowOverlay .arrow-label {
      font-family: "Segoe UI", system-ui, sans-serif;
      font-size: 32px;
      font-weight: 800;
      paint-order: stroke;
      stroke: #fff;
      stroke-width: 6px;
      stroke-linejoin: round;
      opacity: 0;
    }
    #arrowOverlay .arrow-label.show {
      animation: fadeInLabel 0.4s ease-out forwards;
    }
    @keyframes fadeInLabel {
      from { opacity: 0; transform: translateY(5px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    #arrowOverlay .arrow-label.wrong-label { fill: var(--wrong); }
    #arrowOverlay .arrow-label.correct-label { fill: var(--correct); }
    #arrowOverlay polygon {
      fill: var(--wrong);
      opacity: 0;
    }
    #arrowOverlay polygon.show {
      animation: fadeInLabel 0.3s ease-out forwards;
    }

    /* Flag toggle */
    .flag-toggle {
      display: flex;
      align-items: center;
      gap: .5rem;
      padding: .5rem 0;
      cursor: pointer;
      font-size: .95rem;
      user-select: none;
    }
    .flag-toggle input { display: none; }
    .flag-switch {
      width: 40px; height: 22px;
      background: #cbd5e1;
      border-radius: 11px;
      position: relative;
      transition: background .2s;
      flex-shrink: 0;
    }
    .flag-switch::after {
      content: '';
      position: absolute;
      top: 2px; left: 2px;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform .2s;
    }
    .flag-toggle input:checked + .flag-switch {
      background: var(--primary);
    }
    .flag-toggle input:checked + .flag-switch::after {
      transform: translateX(18px);
    }

    /* ---------- Sidebar ---------- */
    .sidebar {
      flex: 1 1 280px;
      max-width: 380px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,.08);
      padding: 1.25rem;
    }

    /* Mode selector */
    .mode-selector { display: flex; gap: .5rem; flex-wrap: wrap; }
    .mode-btn {
      flex: 1 1 auto;
      padding: .6rem .5rem;
      border: 2px solid var(--primary);
      border-radius: 8px;
      background: #fff;
      color: var(--primary);
      font-size: .85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all .15s;
      min-width: 0;
      text-align: center;
    }
    .mode-btn.active, .mode-btn:hover {
      background: var(--primary);
      color: #fff;
    }

    /* Quiz area */
    #quizArea h2 {
      font-size: 1.15rem;
      margin-bottom: .5rem;
      color: var(--muted);
    }
    .question-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      min-height: 2.2rem;
    }
    .feedback {
      margin-top: .75rem;
      font-size: 1.1rem;
      font-weight: 600;
      min-height: 1.6rem;
    }
    .feedback.correct-fb { color: var(--correct); }
    .feedback.wrong-fb   { color: var(--wrong); }

    /* Score â€“ segmented progress bar */
    .score-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .4rem;
    }
    .score-area span { font-size: 1.05rem; }
    .score-num { font-weight: 700; font-size: 1.3rem; }

    .seg-bar {
      display: flex;
      gap: 3px;
      width: 100%;
      height: 18px;
    }
    .seg-bar .seg {
      flex: 1;
      border-radius: 4px;
      background: #e2e8f0;
      transition: background .3s, transform .2s;
    }
    .seg-bar .seg.correct { background: var(--correct); }
    .seg-bar .seg.wrong   { background: var(--wrong); }
    .seg-bar .seg.active  { transform: scaleY(1.25); box-shadow: 0 0 0 2px var(--primary); }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: .65rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform .1s, box-shadow .15s;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { box-shadow: 0 3px 10px rgba(37,99,235,.35); }
    .btn-correct { background: var(--correct); color: #fff; }

    .btn-row { display: flex; gap: .5rem; flex-wrap: wrap; margin-top: .75rem; }

    /* Explore info */
    #exploreInfo {
      font-size: 1.05rem;
      line-height: 1.6;
    }
    #exploreInfo .land-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
    }
    #exploreInfo .capital {
      font-weight: 600;
    }

    /* Cheat-sheet list */
    .cheatsheet { margin-top: .5rem; }
    .cheatsheet li {
      padding: .25rem 0;
      list-style: none;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
    }
    .cheatsheet li:last-child { border: none; }
    .cheatsheet .land { font-weight: 600; }

    /* Completion screen */
    .done-screen {
      text-align: center;
      padding: 1.5rem;
    }
    .done-screen h2 {
      font-size: 1.8rem;
      color: var(--correct);
      margin-bottom: .5rem;
    }
    .done-screen p {
      font-size: 1.1rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }
    .star { font-size: 2.5rem; }

    /* ---- Mobile bottom bar ---- */
    #mobileBar {
      display: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 100;
      background: var(--card);
      box-shadow: 0 -2px 12px rgba(0,0,0,.12);
      padding: .6rem .8rem;
      padding-bottom: calc(.6rem + env(safe-area-inset-bottom));
      align-items: center;
      gap: .5rem;
    }
    #mobileBar .mb-question {
      flex: 1;
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #mobileBar .mb-progress {
      display: flex;
      gap: 2px;
      width: 80px;
      flex-shrink: 0;
      height: 12px;
    }
    #mobileBar .mb-progress .seg {
      flex: 1;
      border-radius: 3px;
      background: #e2e8f0;
      transition: background .3s;
    }
    #mobileBar .mb-progress .seg.correct { background: var(--correct); }
    #mobileBar .mb-progress .seg.wrong   { background: var(--wrong); }
    #mobileBar .mb-toggle {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      padding: 0 .2rem;
      line-height: 1;
      -webkit-tap-highlight-color: transparent;
    }
    #mobileBar .mb-feedback {
      font-size: .85rem;
      font-weight: 600;
    }
    #mobileBar .mb-feedback.correct-fb { color: var(--correct); }
    #mobileBar .mb-feedback.wrong-fb   { color: var(--wrong); }

    /* Responsive */
    @media (max-width: 720px) {
      #mobileBar { display: flex; }
      body { padding-bottom: 56px; }
      header { display: none; }
      .container {
        flex-direction: column-reverse;
        align-items: stretch;
        padding: 0;
        gap: 0;
        max-width: 100%;
      }
      #mapWrap {
        max-width: 100%;
        flex-basis: auto;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
        min-height: calc(100vh - 56px);
        min-height: calc(100dvh - 56px);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #mapWrap svg { width: 100%; height: auto; }
      .sidebar { max-width: 100%; flex-basis: auto; width: 100%; padding: .5rem; }
      .sidebar.collapsed > .card,
      .sidebar.collapsed > div { display: none; }
      .sidebar.collapsed { gap: 0; min-height: 0; padding: 0; }
      .card { padding: 1rem; border-radius: 10px; }
      .mode-btn {
        padding: .7rem .4rem;
        font-size: .8rem;
        min-height: 44px;
      }
      .question-text { font-size: 1.3rem; }
      .feedback { font-size: 1rem; }
      .btn {
        padding: .75rem 1rem;
        font-size: 1rem;
        min-height: 44px;
        width: 100%;
        text-align: center;
      }
      .btn-row { flex-direction: column; }
      .score-area span { font-size: .95rem; }
      .score-num { font-size: 1.1rem; }
      .done-screen h2 { font-size: 1.5rem; }
      .done-screen p { font-size: 1rem; }
      .star { font-size: 2rem; }
      .cheatsheet li { padding: .4rem 0; font-size: .95rem; }
    }

    @media (max-width: 380px) {
      .container { padding: .5rem .25rem; gap: .75rem; }
      header { padding: .75rem .5rem; }
      header h1 { font-size: 1.15rem; }
      .mode-selector { gap: .35rem; }
      .mode-btn { font-size: .75rem; padding: .6rem .3rem; }
      .question-text { font-size: 1.15rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ‡©ğŸ‡ª HauptstÃ¤dte der BundeslÃ¤nder</h1>
  <p>Lerne spielerisch die HauptstÃ¤dte aller 16 BundeslÃ¤nder!</p>
</header>

<div class="container">
  <div id="mapWrap">
    <button id="btnFlagToggle" title="Flaggen ein-/ausblenden">ğŸ³ï¸</button>
    <button id="btnResetZoom">ğŸ” Reset</button>
  </div>

  <div class="sidebar">
    <!-- Mode selector -->
    <div class="card">
      <div class="mode-selector">
        <button class="mode-btn active" data-mode="quiz-capital">ğŸ›ï¸ Hauptstadt finden</button>
        <button class="mode-btn" data-mode="quiz-land">ğŸ—ºï¸ Bundesland finden</button>
        <button class="mode-btn" data-mode="explore">ğŸ” Entdecken</button>
      </div>
    </div>

    <!-- Quiz panel -->
    <div class="card" id="quizArea">
      <p id="questionCounter" style="font-size:.9rem;color:var(--muted);margin-bottom:.35rem;">Frage 1 / 10</p>
      <h2 id="questionLabel">Welches Bundesland hat die Hauptstadt:</h2>
      <div class="question-text" id="questionText">â€¦</div>
      <div class="feedback" id="feedback">&nbsp;</div>
      <div class="btn-row">
        <button class="btn btn-primary" id="btnRestart">ğŸ”„ Neu starten</button>
      </div>
    </div>

    <!-- Explore panel (hidden initially) -->
    <div class="card" id="explorePanel" style="display:none">
      <div id="exploreInfo">
        <p style="color:var(--muted)">Klicke auf ein Bundesland auf der Karte, um seine Hauptstadt zu sehen.</p>
      </div>
    </div>

    <!-- Score -->
    <div class="card" id="scoreCard">
      <div class="score-area">
        <span>Punkte: <span class="score-num" id="scoreText">0 / 10</span></span>
        <span id="streakText"></span>
      </div>
      <div class="seg-bar" id="segBar"></div>
    </div>

    <!-- Flag toggle -->
    <div class="card">
      <label class="flag-toggle">
        <input type="checkbox" id="flagToggle" />
        <span class="flag-switch"></span>
        ğŸ³ï¸ Flaggen auf der Karte anzeigen
      </label>
    </div>

    <!-- Cheat-sheet toggle -->
    <div class="card">
      <button class="btn btn-primary" id="btnCheat" style="width:100%">ğŸ“‹ Alle HauptstÃ¤dte anzeigen</button>
      <ul class="cheatsheet" id="cheatsheet" style="display:none"></ul>
    </div>
  </div>
</div>

<!-- Mobile bottom bar -->
<div id="mobileBar">
  <span class="mb-question" id="mbQuestion">â€¦</span>
  <span class="mb-feedback" id="mbFeedback"></span>
  <div class="mb-progress" id="mbSegBar"></div>
  <button class="mb-toggle" id="mbToggle" aria-label="MenÃ¼">â–²</button>
</div>

<script>
// â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA = {
  DEBW: { name: "Baden-WÃ¼rttemberg",       capital: "Stuttgart"   },
  DEBY: { name: "Bayern",                  capital: "MÃ¼nchen"     },
  DEBE: { name: "Berlin",                  capital: "Berlin"      },
  DEBB: { name: "Brandenburg",             capital: "Potsdam"     },
  DEHB: { name: "Bremen",                  capital: "Bremen"      },
  DEHH: { name: "Hamburg",                 capital: "Hamburg"     },
  DEHE: { name: "Hessen",                  capital: "Wiesbaden"   },
  DEMV: { name: "Mecklenburg-Vorpommern",  capital: "Schwerin"    },
  DENI: { name: "Niedersachsen",            capital: "Hannover"    },
  DENW: { name: "Nordrhein-Westfalen",      capital: "DÃ¼sseldorf"  },
  DERP: { name: "Rheinland-Pfalz",          capital: "Mainz"       },
  DESL: { name: "Saarland",                 capital: "SaarbrÃ¼cken" },
  DESN: { name: "Sachsen",                  capital: "Dresden"     },
  DEST: { name: "Sachsen-Anhalt",            capital: "Magdeburg"   },
  DESH: { name: "Schleswig-Holstein",        capital: "Kiel"        },
  DETH: { name: "ThÃ¼ringen",                capital: "Erfurt"      },
};

const QUIZ_LENGTH = 10;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mode = "quiz-capital";   // "quiz-capital" | "quiz-land" | "explore"
let queue = [];
let currentId = null;
let score = 0;
let questionNum = 0;
let streak = 0;
let answered = false;
const learned = new Set();
const results = [];  // track each answer: 'correct' | 'wrong'

// â”€â”€ DOM refs (static â€“ never replaced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const quizArea     = document.getElementById("quizArea");
const explorePanel = document.getElementById("explorePanel");
const exploreInfo  = document.getElementById("exploreInfo");
const scoreText    = document.getElementById("scoreText");
const streakText   = document.getElementById("streakText");
const segBar       = document.getElementById("segBar");
const mbSegBar     = document.getElementById("mbSegBar");
const cheatsheet   = document.getElementById("cheatsheet");
const btnCheat     = document.getElementById("btnCheat");

// Dynamic refs (elements inside quizArea can be rebuilt)
function $(id) { return document.getElementById(id); }

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function isQuiz() { return mode === "quiz-capital" || mode === "quiz-land"; }

function buildSegBars() {
  [segBar, mbSegBar].forEach(bar => {
    bar.innerHTML = '';
    for (let i = 0; i < QUIZ_LENGTH; i++) {
      const s = document.createElement('div');
      s.className = 'seg';
      if (results[i] === 'correct') s.classList.add('correct');
      else if (results[i] === 'wrong') s.classList.add('wrong');
      if (i === questionNum && questionNum < QUIZ_LENGTH && bar === segBar) s.classList.add('active');
      bar.appendChild(s);
    }
  });
}

function updateScore() {
  scoreText.textContent = `${score} / ${QUIZ_LENGTH}`;
  streakText.textContent = streak >= 2 ? `ğŸ”¥ ${streak} in Folge!` : "";
  buildSegBars();
  syncMobileBar();
}

// â”€â”€ Mobile bar sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mbQuestion = document.getElementById("mbQuestion");
const mbFeedback = document.getElementById("mbFeedback");
const mbToggle   = document.getElementById("mbToggle");
const sidebar    = document.querySelector(".sidebar");
let sidebarCollapsed = false;

function isMobile() { return window.innerWidth <= 720; }

function collapseSidebar() {
  sidebarCollapsed = true;
  sidebar.classList.add("collapsed");
  mbToggle.textContent = "â–²";
}
function expandSidebar() {
  sidebarCollapsed = false;
  sidebar.classList.remove("collapsed");
  mbToggle.textContent = "â–¼";
}

mbToggle.addEventListener("click", () => {
  if (sidebarCollapsed) expandSidebar();
  else collapseSidebar();
});

// Start collapsed on mobile
if (isMobile()) collapseSidebar();

function syncMobileBar() {
  const qt = $("questionText");
  const fb = $("feedback");
  if (qt) mbQuestion.textContent = qt.textContent;
  if (fb && fb.textContent.trim() && fb.textContent.trim() !== '\u00a0') {
    mbFeedback.textContent = fb.textContent;
    mbFeedback.className = "mb-feedback " + (fb.classList.contains("correct-fb") ? "correct-fb" : fb.classList.contains("wrong-fb") ? "wrong-fb" : "");
  } else {
    mbFeedback.textContent = "";
    mbFeedback.className = "mb-feedback";
  }
}

function clearHighlights() {
  document.querySelectorAll(".state").forEach(el => {
    el.classList.remove("active-question", "correct", "wrong", "learned");
    if (learned.has(el.id)) el.classList.add("learned");
  });
  clearArrow();
}

let arrowGroup = null;
function clearArrow() {
  if (arrowGroup) { arrowGroup.innerHTML = ''; }
}
function drawArrow(fromEl, toEl, fromName, toName) {
  if (!arrowGroup) return;
  clearArrow();
  const ns = 'http://www.w3.org/2000/svg';
  const bFrom = fromEl.getBBox();
  const bTo   = toEl.getBBox();
  const x1 = bFrom.x + bFrom.width / 2, y1 = bFrom.y + bFrom.height / 2;
  const x2 = bTo.x + bTo.width / 2,     y2 = bTo.y + bTo.height / 2;
  const lineLen = Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);

  // Wrong label (show immediately)
  const labelFrom = document.createElementNS(ns, 'text');
  labelFrom.setAttribute('x', x1); labelFrom.setAttribute('y', y1 - 20);
  labelFrom.setAttribute('text-anchor', 'middle');
  labelFrom.setAttribute('class', 'arrow-label wrong-label show');
  labelFrom.textContent = `âœ— ${fromName}`;
  arrowGroup.appendChild(labelFrom);

  // Animated dashed line
  const line = document.createElementNS(ns, 'line');
  line.setAttribute('x1', x1); line.setAttribute('y1', y1);
  line.setAttribute('x2', x2); line.setAttribute('y2', y2);
  line.style.strokeDasharray = `${lineLen}`;
  line.style.setProperty('--line-len', `${lineLen}`);
  line.classList.add('animated');
  arrowGroup.appendChild(line);

  // Arrowhead + correct label appear after line animation
  setTimeout(() => {
    const angle = Math.atan2(y2 - y1, x2 - x1);
    const hl = 18, hw = 10;
    const ax = x2 - hl * Math.cos(angle), ay = y2 - hl * Math.sin(angle);
    const p1x = ax - hw * Math.sin(angle), p1y = ay + hw * Math.cos(angle);
    const p2x = ax + hw * Math.sin(angle), p2y = ay - hw * Math.cos(angle);
    const arrow = document.createElementNS(ns, 'polygon');
    arrow.setAttribute('points', `${x2},${y2} ${p1x},${p1y} ${p2x},${p2y}`);
    arrow.classList.add('show');
    arrowGroup.appendChild(arrow);

    const labelTo = document.createElementNS(ns, 'text');
    labelTo.setAttribute('x', x2); labelTo.setAttribute('y', y2 - 20);
    labelTo.setAttribute('text-anchor', 'middle');
    labelTo.setAttribute('class', 'arrow-label correct-label show');
    labelTo.textContent = `âœ“ ${toName}`;
    arrowGroup.appendChild(labelTo);
  }, 800);
}

// â”€â”€ Build / restore quiz panel HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildQuizPanel() {
  quizArea.innerHTML = `
    <p id="questionCounter" style="font-size:.9rem;color:var(--muted);margin-bottom:.35rem;">Frage 1 / ${QUIZ_LENGTH}</p>
    <h2 id="questionLabel">â€¦</h2>
    <div class="question-text" id="questionText">â€¦</div>
    <div class="feedback" id="feedback">&nbsp;</div>
    <div class="btn-row">
      <button class="btn btn-primary" id="btnRestart">ğŸ”„ Neu starten</button>
    </div>`;
}

// â”€â”€ Quiz logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextQuestion() {
  if (queue.length === 0 || questionNum >= QUIZ_LENGTH) { showDone(); return; }
  answered = false;
  clearHighlights();
  currentId = queue.pop();
  const d = DATA[currentId];

  const ql = $("questionLabel"), qt = $("questionText"),
        fb = $("feedback"), qc = $("questionCounter");

  if (mode === "quiz-capital") {
    ql.textContent = "Welches Bundesland hat die Hauptstadt:";
    qt.textContent = d.capital;
  } else {
    ql.textContent = "Wo liegt dieses Bundesland? Klicke darauf:";
    qt.textContent = d.name;
  }
  fb.innerHTML = "&nbsp;";
  fb.className = "feedback";
  qc.textContent = `Frage ${Math.min(questionNum + 1, QUIZ_LENGTH)} / ${QUIZ_LENGTH}`;
  syncMobileBar();
}

function handleQuizClick(el) {
  if (answered || !isQuiz()) return;
  answered = true;
  questionNum++;

  const d  = DATA[currentId];
  const fb = $("feedback"), qc = $("questionCounter");

  if (el.id === currentId) {
    score++; streak++;
    results.push('correct');
    learned.add(el.id);
    el.classList.add("correct");
    fb.textContent = mode === "quiz-capital"
      ? `âœ… Richtig! ${d.name}`
      : `âœ… Richtig! ${d.name} â€“ Hauptstadt: ${d.capital}`;
    fb.className = "feedback correct-fb";
  } else {
    streak = 0;
    results.push('wrong');
    el.classList.add("wrong");
    const ok = document.getElementById(currentId);
    if (ok) ok.classList.add("correct");
    const clickedName = DATA[el.id] ? DATA[el.id].name : el.id;
    drawArrow(el, ok || el, clickedName, d.name);
    fb.innerHTML = mode === "quiz-capital"
      ? `âŒ ${clickedName} ist falsch â€“ richtig: <span style="color:var(--correct)">${d.name}</span>`
      : `âŒ Du klicktest ${clickedName} â€“ richtig: <span style="color:var(--correct)">${d.name}</span>`;
    fb.className = "feedback wrong-fb";
  }

  updateScore();
  qc.textContent = `Frage ${Math.min(questionNum, QUIZ_LENGTH)} / ${QUIZ_LENGTH}`;
  const delay = (el.id === currentId) ? 1500 : 3500;
  setTimeout(nextQuestion, delay);
}

function showDone() {
  const pct = Math.round((score / QUIZ_LENGTH) * 100);
  const emoji = pct === 100 ? "ğŸ†" : pct >= 70 ? "ğŸ‰" : pct >= 40 ? "ğŸ’ª" : "â­";
  quizArea.innerHTML = `
    <div class="done-screen">
      <div class="star">${emoji}</div>
      <h2>${pct === 100 ? "Perfekt!" : "Runde beendet!"}</h2>
      <p>${score} von ${QUIZ_LENGTH} richtig (${pct}%)</p>
      <button class="btn btn-correct" id="btnDoneRestart">ğŸ”„ Nochmal spielen</button>
    </div>`;
  mbQuestion.textContent = `${emoji} ${score}/${QUIZ_LENGTH} richtig!`;
  mbFeedback.textContent = "";
}

function startQuiz() {
  buildQuizPanel();
  queue = shuffle(Object.keys(DATA).slice()).slice(0, QUIZ_LENGTH);
  score = 0; questionNum = 0; streak = 0;
  results.length = 0;
  learned.clear();
  clearHighlights();
  updateScore();
  nextQuestion();
}

// â”€â”€ Explore logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleExploreClick(el) {
  clearHighlights();
  el.classList.add("active-question");
  const d = DATA[el.id];
  if (d) {
    exploreInfo.innerHTML = `
      <div class="land-name">${d.name}</div>
      <p>Hauptstadt: <span class="capital">${d.capital}</span></p>`;
    mbQuestion.textContent = `${d.name} â†’ ${d.capital}`;
    mbFeedback.textContent = "";
    mbFeedback.className = "mb-feedback";
  }
}

// â”€â”€ Event delegation inside quizArea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
quizArea.addEventListener("click", e => {
  const id = e.target.id;
  if (id === "btnRestart")     startQuiz();
  if (id === "btnDoneRestart") startQuiz();
});

// â”€â”€ Mode switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".mode-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    mode = btn.dataset.mode;
    clearHighlights();
    if (isQuiz()) {
      quizArea.style.display = "";
      explorePanel.style.display = "none";
      startQuiz();
    } else {
      quizArea.style.display = "none";
      explorePanel.style.display = "";
      exploreInfo.innerHTML = `<p style="color:var(--muted)">Klicke auf ein Bundesland auf der Karte, um seine Hauptstadt zu sehen.</p>`;
      mbQuestion.textContent = "ğŸ” Tippe auf ein Bundesland";
      mbFeedback.textContent = "";
    }
    if (isMobile()) collapseSidebar();
  });
});

// â”€â”€ Cheat-sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
btnCheat.addEventListener("click", () => {
  const open = cheatsheet.style.display !== "none";
  cheatsheet.style.display = open ? "none" : "";
  btnCheat.textContent = open ? "ğŸ“‹ Alle HauptstÃ¤dte anzeigen" : "ğŸ“‹ HauptstÃ¤dte verbergen";
});
(function buildCheatsheet() {
  const sorted = Object.values(DATA).sort((a, b) => a.name.localeCompare(b.name, "de"));
  sorted.forEach(d => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="land">${d.name}</span><span>${d.capital}</span>`;
    cheatsheet.appendChild(li);
  });
})();

// â”€â”€ Load SVG & wire events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetch("./assets/de.svg")
  .then(r => r.text())
  .then(svgText => {
    const wrap = document.getElementById("mapWrap");
    wrap.insertAdjacentHTML("afterbegin", svgText);
    const svg = wrap.querySelector("svg");
    svg.querySelectorAll("#points, #label_points").forEach(g => g.remove());

    svg.querySelectorAll("[id^='DE']").forEach(el => {
      if (el.tagName !== "path") return;
      el.classList.add("state");
      el.addEventListener("click", () => {
        if (isQuiz()) handleQuizClick(el);
        else handleExploreClick(el);
      });
    });

    // â”€â”€ Flag overlays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const flagGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
    flagGroup.id = "flagOverlays";
    flagGroup.style.display = "none";
    flagGroup.style.pointerEvents = "none";
    flagGroup.setAttribute("opacity", "0.82");

    Object.keys(DATA).forEach(stateId => {
      const path = svg.querySelector(`#${stateId}`);
      if (!path) return;

      const bbox = path.getBBox();
      // Small centered flag: 30% of the shorter dimension
      const flagSize = Math.min(bbox.width, bbox.height) * 0.30;
      const flagW = flagSize * 1.5; // flag aspect ratio ~3:2
      const flagH = flagSize;
      const cx = bbox.x + bbox.width / 2;
      const cy = bbox.y + bbox.height / 2;

      const img = document.createElementNS("http://www.w3.org/2000/svg", "image");
      img.setAttribute("href", `./assets/flags/${stateId}.svg`);
      img.setAttribute("x", cx - flagW / 2);
      img.setAttribute("y", cy - flagH / 2);
      img.setAttribute("width", flagW);
      img.setAttribute("height", flagH);
      img.setAttribute("preserveAspectRatio", "xMidYMid meet");
      flagGroup.appendChild(img);
    });

    svg.appendChild(flagGroup);
    // Create arrow overlay group
    arrowGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
    arrowGroup.id = "arrowOverlay";
    svg.appendChild(arrowGroup);
    const flagToggle = document.getElementById("flagToggle");
    const btnFlagToggle = document.getElementById("btnFlagToggle");

    flagToggle.addEventListener("change", () => {
      flagGroup.style.display = flagToggle.checked ? "" : "none";
      btnFlagToggle.classList.toggle("active", flagToggle.checked);
    });

    btnFlagToggle.addEventListener("click", () => {
      flagToggle.checked = !flagToggle.checked;
      flagToggle.dispatchEvent(new Event("change"));
    });

    // Sync initial button state with checkbox
    btnFlagToggle.classList.toggle("active", flagToggle.checked);

    // â”€â”€ Map zoom & pan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let scale = 1, panX = 0, panY = 0;
    let startDist = 0, startScale = 1;
    let startTouches = null, startPanX = 0, startPanY = 0;
    const MIN_SCALE = 1, MAX_SCALE = 5;
    const resetBtn = document.getElementById("btnResetZoom");

    function applyTransform() {
      // Clamp pan so map doesn't go out of bounds
      const rect = wrap.getBoundingClientRect();
      const svgW = rect.width * scale;
      const svgH = rect.height * scale;
      const maxPanX = Math.max(0, svgW - rect.width);
      const maxPanY = Math.max(0, svgH - rect.height);
      panX = Math.min(0, Math.max(-maxPanX, panX));
      panY = Math.min(0, Math.max(-maxPanY, panY));
      svg.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
      svg.style.transition = "none";
      resetBtn.style.display = scale > 1.05 ? "block" : "none";
    }

    function resetZoom() {
      scale = 1; panX = 0; panY = 0;
      svg.style.transition = "transform .25s ease";
      svg.style.transform = "translate(0,0) scale(1)";
      resetBtn.style.display = "none";
    }
    resetBtn.addEventListener("click", resetZoom);

    function touchDist(t) {
      const dx = t[0].clientX - t[1].clientX;
      const dy = t[0].clientY - t[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    function touchCenter(t) {
      return {
        x: (t[0].clientX + t[1].clientX) / 2,
        y: (t[0].clientY + t[1].clientY) / 2
      };
    }

    wrap.addEventListener("touchstart", e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        startDist = touchDist(e.touches);
        startScale = scale;
        startTouches = touchCenter(e.touches);
        startPanX = panX;
        startPanY = panY;
      } else if (e.touches.length === 1 && scale > 1.05) {
        startTouches = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        startPanX = panX;
        startPanY = panY;
      }
    }, { passive: false });

    wrap.addEventListener("touchmove", e => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dist = touchDist(e.touches);
        const center = touchCenter(e.touches);
        const rect = wrap.getBoundingClientRect();
        const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, startScale * (dist / startDist)));
        // Zoom toward pinch center
        const cx = center.x - rect.left;
        const cy = center.y - rect.top;
        panX = cx - (cx - startPanX) * (newScale / startScale) + (center.x - startTouches.x);
        panY = cy - (cy - startPanY) * (newScale / startScale) + (center.y - startTouches.y);
        scale = newScale;
        applyTransform();
      } else if (e.touches.length === 1 && scale > 1.05) {
        e.preventDefault();
        panX = startPanX + (e.touches[0].clientX - startTouches.x);
        panY = startPanY + (e.touches[0].clientY - startTouches.y);
        applyTransform();
      }
    }, { passive: false });

    // Mouse wheel zoom (desktop)
    wrap.addEventListener("wheel", e => {
      e.preventDefault();
      const rect = wrap.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      const factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
      const newScale = Math.min(MAX_SCALE, Math.max(MIN_SCALE, scale * factor));
      panX = cx - (cx - panX) * (newScale / scale);
      panY = cy - (cy - panY) * (newScale / scale);
      scale = newScale;
      applyTransform();
    }, { passive: false });

    startQuiz();
  });
</script>
</body>
</html>
